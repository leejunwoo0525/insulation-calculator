<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‹¨ì—´ì¬ ì¶”ì²œ ê³„ì‚°ê¸°</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .tab { display: none; }
    .tab.active { display: block; }
    button.tab-btn { margin-right: 10px; padding: 10px 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    input, select { width: 140px; }
    .grade-A { background-color: #d4f8cc; }
    .grade-B { background-color: #fff8b2; }
    .grade-C { background-color: #ffe0b2; }
    .grade-D { background-color: #f8cccc; }
    #result { margin-top: 30px; }
  </style>
</head>
<body>
<h2>ğŸ“¦ ë‹¨ì—´ì¬ ì¶”ì²œ ê³„ì‚°ê¸°</h2>
<div>
  <button class="tab-btn" onclick="switchTab('calculator')">ê³„ì‚°ê¸°</button>
  <button class="tab-btn" onclick="switchTab('database')">ë‹¨ì—´ì¬ ëª©ë¡</button>
</div>

<div class="tab active" id="calculator">
  <h3>ğŸ“ ë²½ì²´ ë ˆì´ì–´ êµ¬ì„±</h3>
  <table id="layerTable">
    <thead>
      <tr>
        <th>ì¬ë£Œëª…</th>
        <th>ë‘ê»˜ (mm)</th>
        <th>ì—´ì „ë„ìœ¨ Î»</th>
        <th>ì—´ì €í•­ R</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody>
      <tr class="fixed-layer">
        <td><input type="text" readonly value="ì‹¤ì™¸ ì—´ì „ë‹¬ì €í•­"></td>
        <td><input type="number" readonly value="0"></td>
        <td><input type="text" readonly value="-"></td>
        <td><input class="resistance" type="number" readonly value="0.043"></td>
        <td></td>
      </tr>
      <tr>
        <td>
          <input type="text" list="insulationNames" placeholder="ì¬ë£Œëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ" 
                 onchange="fillFromInput(this)"
                 onfocus="handleMaterialFocus(this)" 
                 onblur="handleMaterialBlur(this)">
          <datalist id="insulationNames"></datalist>
        </td>
        <td><input type="number" oninput="updateResistance(this)"></td>
        <td><input type="number" oninput="updateResistance(this)"></td>
        <td><input class="resistance" type="number" readonly></td>
        <td><button onclick="removeRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr class="fixed-layer">
        <td><input type="text" readonly value="ì‹¤ë‚´ ì—´ì „ë‹¬ì €í•­"></td>
        <td><input type="number" readonly value="0"></td>
        <td><input type="text" readonly value="-"></td>
        <td><input class="resistance" type="number" readonly value="0.11"></td>
        <td></td>
      </tr>
    </tbody>
  </table>
  <button onclick="addRow()">ë ˆì´ì–´ ì¶”ê°€</button>
  <h4>ë‹¨ì—´ì¬ ë‘ê»˜ (mm): <input id="insulationThickness" type="number"/></h4>
  <h4>ì§€ì—­: 
    <select id="region">
      <option value="ì¤‘ë¶€1">ì¤‘ë¶€1</option>
      <option value="ì¤‘ë¶€2">ì¤‘ë¶€2</option>
      <option value="ë‚¨ë¶€">ë‚¨ë¶€</option>
      <option value="ì œì£¼">ì œì£¼</option>
    </select>
    ë¶€ìœ„:
    <select id="zone">
      <option value="ì™¸ë²½">ì™¸ë²½</option>
      <option value="ì§€ë¶•">ì§€ë¶•</option>
      <option value="ë°”ë‹¥">ë°”ë‹¥</option>
    </select>
  </h4>
  <button onclick="calculate()">ì¶”ì²œ</button>
  <button onclick="window.print()">ğŸ“„ PDF ì €ì¥</button>
  <div id="result"></div>
</div>

<div class="tab" id="database">
  <h3>ğŸ“‹ ë‹¨ì—´ì¬ ëª©ë¡</h3>
  <table id="insulationTable">
    <thead><tr><th>ì´ë¦„</th><th>Î»</th><th>ë“±ê¸‰</th><th>ê°€ê²©</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>â• ë‹¨ì—´ì¬ ì¶”ê°€</h4>
  <input id="newName" placeholder="ì´ë¦„" type="text"/>
  <input id="newLambda" placeholder="Î» (W/mÂ·K)" type="number"/>
  <input id="newGrade" placeholder="ë“±ê¸‰" type="text"/>
  <input id="newPrice" placeholder="ê°€ê²©(ì›/ã¡)" type="number"/>
  <button onclick="addCustomInsulation()">ì¶”ê°€</button>
</div>

<script>
const uStandardTable = {
  'ì™¸ë²½': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.17, 'ë‚¨ë¶€': 0.22, 'ì œì£¼': 0.29 },
  'ì§€ë¶•': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.18, 'ë‚¨ë¶€': 0.25, 'ì œì£¼': 0.25 },
  'ë°”ë‹¥': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.17, 'ë‚¨ë¶€': 0.22, 'ì œì£¼': 0.29 }
};

let insulationList = [
  {name: "PFë³´ë“œ A", lambda: 0.019, grade: "ë¶ˆì—°", price: 22000},
  {name: "ê²½ì§ˆìš°ë ˆíƒ„ B", lambda: 0.025, grade: "ì¤€ë¶ˆì—°", price: 18000},
  {name: "XPS C", lambda: 0.034, grade: "ë‚œì—°", price: 11000},
  {name: "ì§„ê³µë‹¨ì—´ D", lambda: 0.005, grade: "ë¶ˆì—°", price: 50000},
  {name: "EPS E", lambda: 0.038, grade: "ë‚œì—°", price: 8000}
];

// ì „ì—­ ë³€ìˆ˜ë¡œ í¬ì»¤ìŠ¤ëœ inputì˜ ì›ë˜ ê°’ì„ ì €ì¥
let materialInputOriginalValue = '';

function handleMaterialFocus(inputElement) {
    materialInputOriginalValue = inputElement.value;
    inputElement.value = ''; // ê°’ì„ ë¹„ì›Œì„œ datalistê°€ ëª¨ë“  ì˜µì…˜ì„ ë³´ì—¬ì£¼ë„ë¡ í•¨
}

function handleMaterialBlur(inputElement) {
    // setTimeoutì„ ì‚¬ìš©í•˜ì—¬ onchangeê°€ ë°œìƒí•˜ê³  input.valueê°€ ì—…ë°ì´íŠ¸ë  ì‹œê°„ì„ ì•½ê°„ ê¸°ë‹¤ë¦° í›„ íŒë‹¨.
    setTimeout(() => {
        if (inputElement.value === '' && materialInputOriginalValue !== '') {
            // ì‚¬ìš©ìê°€ í¬ì»¤ìŠ¤ í›„ ê°’ì„ ë¹„ìš°ê³ , ìƒˆ ê°’ì„ ì„ íƒí•˜ì§€ ì•Šê³  ë¸”ëŸ¬í•œ ê²½ìš°
            inputElement.value = materialInputOriginalValue; // ì›ë˜ ì¬ë£Œëª…ìœ¼ë¡œ ë³µì›
            fillFromInput(inputElement); // ë³µì›ëœ ì¬ë£Œëª…ì— ë”°ë¼ ëŒë‹¤ ë“± ì—…ë°ì´íŠ¸
        }
    }, 0); 
}

function fillFromInput(input) { // inputì€ ì¬ë£Œëª… input element
    const value = input.value;
    const row = input.closest("tr");
    const lambdaInput = row.cells[2].querySelector('input');
    const insulation = insulationList.find(ins => ins.name === value);

    if (insulation) {
        lambdaInput.value = insulation.lambda;
    } else {
        // ëª©ë¡ì— ì—†ëŠ” ì´ë¦„ì´ê±°ë‚˜, ì´ë¦„ì´ ì§€ì›Œì§„ ê²½ìš°
        if (value === '') { // ì‚¬ìš©ìê°€ ì´ë¦„ì„ ì™„ì „íˆ ì§€ì› ë‹¤ë©´
            lambdaInput.value = '';
        }
        // ì´ë¦„ì€ ìˆì§€ë§Œ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°, lambdaëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ë„ë¡ í˜„ì¬ ê°’ ìœ ì§€.
    }
    updateResistance(lambdaInput); // lambdaInput.valueì— ë”°ë¼ Rê°’ ì—…ë°ì´íŠ¸
}

function switchTab(id) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function updateResistance(input) {
  const row = input.closest("tr");
  const t = parseFloat(row.cells[1].querySelector('input').value) / 1000; // ë‘ê»˜
  const l = parseFloat(row.cells[2].querySelector('input').value); // ì—´ì „ë„ìœ¨
  const R_input = row.cells[3].querySelector('input'); // ì—´ì €í•­ input
  if (!isNaN(t) && !isNaN(l) && l > 0 && t >= 0) { // ë‘ê»˜ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•¨
    R_input.value = (t / l).toFixed(3);
  } else {
    R_input.value = '';
  }
}

function addRow() {
  const tbody = document.querySelector("#layerTable tbody");
  const row = document.createElement("tr");
  // row.setAttribute("onclick", "selectRow(this)"); // ì´ í•¨ìˆ˜ëŠ” ì •ì˜ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì œê±°
  row.innerHTML = `
    <td>
      <input type="text" list="insulationNames" placeholder="ì¬ë£Œëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ" 
             onchange="fillFromInput(this)" 
             onfocus="handleMaterialFocus(this)" 
             onblur="handleMaterialBlur(this)">
    </td>
    <td><input type="number" oninput="updateResistance(this)"></td>
    <td><input type="number" oninput="updateResistance(this)"></td>
    <td><input class="resistance" type="number" readonly></td>
    <td><button onclick="removeRow(this)">ì‚­ì œ</button></td>
  `;
  const rows = tbody.querySelectorAll("tr");
  tbody.insertBefore(row, rows[rows.length - 1]); // ë§ˆì§€ë§‰ ê³ ì •í–‰ ë°”ë¡œ ìœ„ì— ì‚½ì…
}

function removeRow(btn) {
  const row = btn.closest("tr");
  row.remove();
}

function updateInsulationTable() {
  const tbody = document.querySelector("#insulationTable tbody");
  tbody.innerHTML = "";
  const datalist = document.getElementById("insulationNames");
  datalist.innerHTML = ""; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
  for (const item of insulationList) {
    tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.lambda}</td><td>${item.grade}</td><td>${item.price}</td></tr>`;
    datalist.innerHTML += `<option value="${item.name}">`;
  }
}

function addCustomInsulation() {
  const name = document.getElementById("newName").value;
  const lambda = parseFloat(document.getElementById("newLambda").value);
  const grade = document.getElementById("newGrade").value;
  const price = parseFloat(document.getElementById("newPrice").value);
  if (!name || isNaN(lambda) || lambda <= 0) { // ì´ë¦„, lambda ìœ íš¨ì„± ê²€ì‚¬ (lambdaëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•¨)
    alert("ì´ë¦„ê³¼ ìœ íš¨í•œ Î» ê°’ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  insulationList.push({name, lambda, grade, price: price || 0 }); // ê°€ê²©ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ
  updateInsulationTable();
  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  document.getElementById("newName").value = '';
  document.getElementById("newLambda").value = '';
  document.getElementById("newGrade").value = '';
  document.getElementById("newPrice").value = '';
}

function calculate() {
  const region = document.getElementById('region').value;
  const zone = document.getElementById('zone').value;
  const insulationThicknessInput = document.getElementById('insulationThickness');
  const thickness = parseFloat(insulationThicknessInput.value) / 1000; // mm to m

  if (isNaN(thickness) || thickness <= 0) {
    alert("ë‹¨ì—´ì¬ ë‘ê»˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (0ë³´ë‹¤ í° ê°’).");
    insulationThicknessInput.focus();
    return;
  }

  let R_wall_parts = 0; // ë‹¨ì—´ì¬ ì™¸ ë‹¤ë¥¸ ë ˆì´ì–´ë“¤ì˜ ì—´ì €í•­ í•©
  let hasUserLayer = false;
  // ì²« ë²ˆì§¸ í–‰(ì‹¤ì™¸ ì—´ì „ë‹¬ì €í•­)ê³¼ ë§ˆì§€ë§‰ í–‰(ì‹¤ë‚´ ì—´ì „ë‹¬ì €í•­)ì„ ì œì™¸í•˜ê³ ,
  // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ë ˆì´ì–´ë“¤ ì¤‘ì—ì„œ ì¬ë£Œëª…, ë‘ê»˜, ì—´ì „ë„ìœ¨ì´ ëª¨ë‘ ì…ë ¥ëœ ê²ƒë§Œ ê³„ì‚°
  const layerRows = document.querySelectorAll("#layerTable tbody tr");
  layerRows.forEach((row, index) => {
    if (!row.classList.contains('fixed-layer')) {
        hasUserLayer = true;
        const materialNameInput = row.cells[0].querySelector('input');
        const thicknessInput = row.cells[1].querySelector('input');
        const lambdaInput = row.cells[2].querySelector('input');
        const resistanceInput = row.cells[3].querySelector('input'); // ì´ë¯¸ ê³„ì‚°ëœ ì—´ì €í•­ ê°’

        // ì¬ë£Œëª…, ë‘ê»˜, ëŒë‹¤ê°€ ëª¨ë‘ ì±„ì›Œì ¸ ê³„ì‚°ëœ ì €í•­ê°’ì´ ìˆë‹¤ë©´ ì‚¬ìš©
        if (materialNameInput && materialNameInput.value && 
            thicknessInput && !isNaN(parseFloat(thicknessInput.value)) &&
            lambdaInput && !isNaN(parseFloat(lambdaInput.value)) &&
            resistanceInput && !isNaN(parseFloat(resistanceInput.value)) ) {
            R_wall_parts += parseFloat(resistanceInput.value);
        }
    }
  });
  
  // ê³ ì •ëœ ì‹¤ë‚´ì™¸ ì—´ì „ë‹¬ì €í•­ ë”í•˜ê¸°
  const fixedResistances = document.querySelectorAll("#layerTable tbody tr.fixed-layer .resistance");
  fixedResistances.forEach(r => {
    const val = parseFloat(r.value);
    if (!isNaN(val)) R_wall_parts += val;
  });

  if (!hasUserLayer) {
      alert("í•˜ë‚˜ ì´ìƒì˜ ë²½ì²´ ë ˆì´ì–´ë¥¼ êµ¬ì„±í•˜ê³  ì¬ë£Œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
  }

  const U_target = uStandardTable[zone][region];
  const R_required_total = 1 / U_target;
  
  // ë²½ì²´ ìì²´ì˜ ì—´ì €í•­ (R_wall_parts) ë§Œìœ¼ë¡œëŠ” ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ì—†ìŒ.
  // ë‹¨ì—´ì¬ê°€ ì¶”ê°€ë  ë•Œ, ê·¸ ë‹¨ì—´ì¬ê°€ ê°ë‹¹í•´ì•¼ í•  ì—´ì €í•­ì€ R_insulation_needed
  // í˜„ì¬ ë¡œì§ì€ 'ì¶”ê°€ ë‹¨ì—´ì¬'ê°€ ì•„ë‹ˆë¼ 'ì§€ì •ëœ ë‘ê»˜'ì˜ ë‹¨ì—´ì¬ë¥¼ ìœ„í•œ lambda_maxë¥¼ ì°¾ìŒ.
  // R_wall_partsëŠ” í˜„ì¬ *ëª¨ë“ * ë ˆì´ì–´(ê³ ì •ì €í•­ í¬í•¨)ì˜ í•©.
  // í•„ìš”í•œ ë‹¨ì—´ì¬ì˜ ì—´ì €í•­: R_insulation_needed = R_required_total - (R_wall_parts - R_of_insulation_being_calculated)
  // í˜„ì¬ ê³„ì‚° ë°©ì‹ì€ ì§€ì •ëœ ë‘ê»˜(thickness)ì˜ "ì–´ë–¤ ë‹¨ì—´ì¬"ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ, ê·¸ ë‹¨ì—´ì¬ì˜ ìµœëŒ€ í—ˆìš© lambdaë¥¼ ì°¾ëŠ” ê²ƒ.
  // ì—¬ê¸°ì„œ R_wallì€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‹¤ë¥¸ ë ˆì´ì–´ë“¤ì˜ ì—´ì €í•­ì˜ í•© + ê³ ì • ì—´ì €í•­.
  // ì´ R_wallì— thickness/lambda_maxë¥¼ ë”í–ˆì„ ë•Œ R_required_totalì´ ë˜ì–´ì•¼ í•¨.
  // R_wall_parts (í˜„ì¬ ëª¨ë“  ë ˆì´ì–´ ì €í•­ í•©) + thickness/lambda_max = R_required_total
  // thickness/lambda_max = R_required_total - R_wall_parts
  // lambda_max = thickness / (R_required_total - R_wall_parts)

  const R_additional_needed_from_insulation = R_required_total - R_wall_parts;

  if (R_additional_needed_from_insulation <= 0) {
      // ì´ë¯¸ ê¸°ì¤€ì„ ë§Œì¡±í•˜ê±°ë‚˜ ì´ˆê³¼í•œ ê²½ìš°
      const current_U_wall = R_wall_parts > 0 ? (1 / R_wall_parts).toFixed(3) : "âˆ";
      document.getElementById("result").innerHTML = `<p>ğŸ“Œ ê¸°ì¤€ ì—´ê´€ë¥˜ìœ¨: <b>${U_target} W/ã¡Â·K</b></p>
        <p>ğŸ§® í˜„ì¬ ë²½ì²´ ì´ ì—´ì €í•­ (R_total): <b>${R_wall_parts.toFixed(3)} mÂ²Â·K/W</b></p>
        <p>ğŸ§® í˜„ì¬ ë²½ì²´ ì—´ê´€ë¥˜ìœ¨ (U): <b>${current_U_wall} W/ã¡Â·K</b></p>
        <p>âœ… í˜„ì¬ êµ¬ì„±ìœ¼ë¡œ ì´ë¯¸ ë²•ì  ê¸°ì¤€ ì—´ê´€ë¥˜ìœ¨(<b>${U_target} W/ã¡Â·K</b>)ì„ ë§Œì¡±í•©ë‹ˆë‹¤. 
           (í•„ìš” ì¶”ê°€ ì—´ì €í•­ â‰¤ 0)</p>`;
      return;
  }

  const lambda_max = thickness / R_additional_needed_from_insulation;

  const resultDiv = document.getElementById("result");
  const current_U_wall = R_wall_parts > 0 ? (1 / R_wall_parts).toFixed(3) : "âˆ";

  resultDiv.innerHTML = `<p>ğŸ“Œ ê¸°ì¤€ ì—´ê´€ë¥˜ìœ¨ (U_target): <b>${U_target} W/ã¡Â·K</b> (ëª©í‘œ ì´ ì—´ì €í•­ R_required_total: ${R_required_total.toFixed(3)} mÂ²Â·K/W)</p>
    <p>ğŸ§± í˜„ì¬ êµ¬ì„±ëœ ë ˆì´ì–´ë“¤ì˜ ì´ ì—´ì €í•­ (R_wall_parts): <b>${R_wall_parts.toFixed(3)} mÂ²Â·K/W</b> (í˜„ì¬ ì—´ê´€ë¥˜ìœ¨ U_wall_parts: ${current_U_wall} W/ã¡Â·K)</p>
    <p>ğŸ”¥ ì§€ì •ëœ ë‘ê»˜(${insulationThicknessInput.value}mm)ì˜ ë‹¨ì—´ì¬ê°€ ì¶”ê°€ë¡œ ì œê³µí•´ì•¼ í•˜ëŠ” ì—´ì €í•­ (R_insulation_needed): <b>${R_additional_needed_from_insulation.toFixed(3)} mÂ²Â·K/W</b></p>
    <p>ğŸ¯ í•´ë‹¹ ë‘ê»˜(${insulationThicknessInput.value}mm)ë¡œ ìœ„ ì—´ì €í•­ì„ ë§Œì¡±í•˜ê¸° ìœ„í•œ ìµœëŒ€ í—ˆìš© ì—´ì „ë„ìœ¨ (Î»_max) â‰¤ <b>${lambda_max.toFixed(3)} W/mÂ·K</b></p>
    <h3>âœ… ì¶”ì²œ ë‹¨ì—´ì¬ (Î» â‰¤ ${lambda_max.toFixed(3)})</h3>`;

  const ul = document.createElement("ul");
  let found = false;
  for (const ins of insulationList) {
    if (ins.lambda <= lambda_max) {
      const li = document.createElement("li");
      li.textContent = `${ins.name} (Î»=${ins.lambda}, ${ins.grade || 'ì •ë³´ì—†ìŒ'}, ${ins.price ? ins.price + 'ì›/ã¡' : 'ê°€ê²©ì •ë³´ì—†ìŒ'})`;
      ul.appendChild(li);
      found = true;
    }
  }
  if (!found) {
    const li = document.createElement("li");
    li.textContent = "ì¶”ì²œ ë‹¨ì—´ì¬ ì—†ìŒ (ê¸°ì¤€ì„ ë§Œì¡±í•˜ëŠ” ë‹¨ì—´ì¬ê°€ ëª©ë¡ì— ì—†ê±°ë‚˜, Î»_maxê°€ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤).";
    ul.appendChild(li);
  }
  resultDiv.appendChild(ul);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¨ì—´ì¬ ëª©ë¡ í…Œì´ë¸” ë° datalist ì—…ë°ì´íŠ¸
updateInsulationTable();
</script>
</body>
</html>
