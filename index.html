# 통합 HTML + PDF 저장 버튼 + 등급별 색상 적용
pdf_and_grade_html = """
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>단열재 추천 및 열관류율 계산기</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    input, select { width: 140px; }
    button { margin: 10px 5px; padding: 6px 16px; }
    tr.selected { background-color: #e0f0ff; }
    #result { margin-top: 30px; }
    .grade-A { background-color: #d4f8cc; }
    .grade-B { background-color: #fff8b2; }
    .grade-C { background-color: #ffe0b2; }
    .grade-D { background-color: #f8cccc; }
  </style>
</head>
<body>
  <h2>📦 단열재 추천 및 열관류율 계산기</h2>

  <label>지역:
    <select id="region">
      <option value="중부1">중부1지역</option>
      <option value="중부2">중부2지역</option>
      <option value="남부">남부지역</option>
      <option value="제주">제주도</option>
    </select>
  </label>

  <label>부위:
    <select id="zone">
      <option value="외벽">외벽</option>
      <option value="지붕">지붕</option>
      <option value="바닥">바닥</option>
    </select>
  </label>

  <h3>🎯 적용할 재료 선택</h3>
  <select id="materialSelect" onchange="updateMaterialLambda()">
    <option value="">-- 재료 선택 --</option>
    <option value="콘크리트,1.6">콘크리트</option>
    <option value="시멘트몰탈,0.9">시멘트몰탈</option>
    <option value="PF보드,0.021">PF보드</option>
    <option value="우레탄폼,0.024">우레탄폼</option>
    <option value="비드법보온판 1종 1호,0.037">비드법보온판 1종 1호</option>
  </select>
  <input type="text" id="lambdaValue" placeholder="λ 자동입력" readonly />
  <button onclick="applyMaterialToRow()">선택 레이어에 적용</button>

  <h3>📐 벽체 레이어 구성</h3>
  <table id="layerTable">
    <thead>
      <tr>
        <th>재료명</th>
        <th>두께 (mm)</th>
        <th>열전도율 λ</th>
        <th>열저항 R</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody>
      <tr class="fixed-layer">
        <td><input type="text" value="실외 열전달저항" readonly /></td>
        <td><input type="number" value="0" readonly /></td>
        <td><input type="text" value="-" readonly /></td>
        <td><input type="number" value="0.043" readonly class="resistance" /></td>
        <td></td>
      </tr>
      <tr onclick="selectRow(this)">
        <td><input type="text" /></td>
        <td><input type="number" oninput="updateResistance(this)" /></td>
        <td><input type="number" oninput="updateResistance(this)" /></td>
        <td><input type="number" readonly class="resistance" /></td>
        <td><button onclick="removeRow(this)">삭제</button></td>
      </tr>
      <tr class="fixed-layer">
        <td><input type="text" value="실내 열전달저항" readonly /></td>
        <td><input type="number" value="0" readonly /></td>
        <td><input type="text" value="-" readonly /></td>
        <td><input type="number" value="0.11" readonly class="resistance" /></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">레이어 추가</button>

  <label>단열재 두께 (mm):</label>
  <input type="number" id="insulationThickness" />
  <button onclick="calculate()">계산 및 추천</button>
  <button onclick="window.print()">📄 PDF로 저장</button>

  <div id="result"></div>

  <script>
    const uStandardTable = {
      '외벽': { '중부1': 0.15, '중부2': 0.17, '남부': 0.22, '제주': 0.29 },
      '지붕': { '중부1': 0.15, '중부2': 0.18, '남부': 0.25, '제주': 0.25 },
      '바닥': { '중부1': 0.15, '중부2': 0.17, '남부': 0.22, '제주': 0.29 }
    };

    const insulationDB = {
      "PF보드": 0.021,
      "우레탄폼": 0.024,
      "비드법보온판 1종 1호": 0.037
    };

    let selectedRow = null;

    function updateMaterialLambda() {
      const val = document.getElementById("materialSelect").value.split(",");
      document.getElementById("lambdaValue").value = val[1] || "";
    }

    function selectRow(row) {
      document.querySelectorAll("#layerTable tr").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      selectedRow = row;
    }

    function applyMaterialToRow() {
      if (!selectedRow) return alert("먼저 레이어를 선택하세요.");
      const val = document.getElementById("materialSelect").value.split(",");
      if (val.length < 2) return alert("재료를 선택하세요.");
      selectedRow.cells[0].querySelector('input').value = val[0];
      selectedRow.cells[2].querySelector('input').value = val[1];
      updateResistance(selectedRow.cells[2].querySelector('input'));
    }

    function updateResistance(input) {
      const row = input.closest("tr");
      const t = parseFloat(row.cells[1].querySelector('input').value) / 1000;
      const l = parseFloat(row.cells[2].querySelector('input').value);
      const R = row.cells[3].querySelector('input');
      if (!isNaN(t) && !isNaN(l) && l > 0) R.value = (t / l).toFixed(3);
      else R.value = '';
      showUvalue();
    }

    function addRow() {
      const tbody = document.querySelector("#layerTable tbody");
      const row = document.createElement("tr");
      row.setAttribute("onclick", "selectRow(this)");
      row.innerHTML = `
        <td><input type="text" /></td>
        <td><input type="number" oninput="updateResistance(this)" /></td>
        <td><input type="number" oninput="updateResistance(this)" /></td>
        <td><input type="number" readonly class="resistance" /></td>
        <td><button onclick="removeRow(this)">삭제</button></td>`;
      tbody.insertBefore(row, tbody.lastElementChild);
    }

    function removeRow(btn) {
      const row = btn.closest("tr");
      row.remove();
      showUvalue();
    }

    function showUvalue() {
      const resistances = document.querySelectorAll(".resistance");
      let totalR = 0;
      resistances.forEach(r => {
        const val = parseFloat(r.value);
        if (!isNaN(val)) totalR += val;
      });

      const resultDiv = document.getElementById('result');
      if (totalR > 0) {
        resultDiv.innerHTML = `<p>🧮 벽체 전체 열관류율 (U): <b>${(1 / totalR).toFixed(3)} W/㎡·K</b></p>`;
      }
    }

    function getGradeClass(lambda) {
      if (lambda <= 0.034) return 'grade-A';
      if (lambda <= 0.040) return 'grade-B';
      if (lambda <= 0.046) return 'grade-C';
      return 'grade-D';
    }

    function calculate() {
      const region = document.getElementById('region').value;
      const zone = document.getElementById('zone').value;
      const thickness = parseFloat(document.getElementById('insulationThickness').value) / 1000;

      let R_wall = 0;
      document.querySelectorAll(".resistance").forEach(r => {
        const val = parseFloat(r.value);
        if (!isNaN(val)) R_wall += val;
      });

      const U_target = uStandardTable[zone][region];
      const R_required = 1 / U_target;
      const R_needed = R_required - R_wall;
      const lambda_max = thickness / R_needed;

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `
        <p>📌 기준 열관류율: <b>${U_target} W/㎡·K</b></p>
        <p>🧮 현재 벽체 열관류율 (U): <b>${(1 / R_wall).toFixed(3)} W/㎡·K</b></p>
        <p>🎯 필요한 λ ≤ <b>${lambda_max.toFixed(3)} W/m·K</b></p>
      `;

      const resultList = document.createElement('ul');

      let count = 0;
      for (const [name, lambda] of Object.entries(insulationDB)) {
        if (lambda <= lambda_max) {
          const li = document.createElement('li');
          li.className = getGradeClass(lambda);
          li.innerHTML = `${name} (λ=${lambda})`;
          resultList.appendChild(li);
          count++;
        }
      }

      if (count === 0) {
        resultDiv.innerHTML += `<p>❌ 조건을 만족하는 단열재가 없습니다.</p>`;
      } else {
        resultDiv.innerHTML += `<h3>✅ 추천 단열재</h3>`;
        resultDiv.appendChild(resultList);
      }
    }
  </script>
</body>
</html>
"""

# 저장
final_color_pdf_path = Path("/mnt/data/index_pdf_등급색.html")
final_color_pdf_path.write_text(pdf_and_grade_html, encoding="utf-8")
final_color_pdf_path.name
