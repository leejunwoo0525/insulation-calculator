<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‹¨ì—´ì¬ ì¶”ì²œ ê³„ì‚°ê¸°</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .tab { display: none; }
    .tab.active { display: block; }
    button.tab-btn { margin-right: 10px; padding: 10px 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    input, select { width: 140px; }
    .grade-A { background-color: #d4f8cc; }
    .grade-B { background-color: #fff8b2; }
    .grade-C { background-color: #ffe0b2; }
    .grade-D { background-color: #f8cccc; }
    #result { margin-top: 30px; }
  </style>
</head>
<body>
<h2>ğŸ“¦ ë‹¨ì—´ì¬ ì¶”ì²œ ê³„ì‚°ê¸°</h2>
<div>
  <button class="tab-btn" onclick="switchTab('calculator')">ê³„ì‚°ê¸°</button>
  <button class="tab-btn" onclick="switchTab('database')">ë‹¨ì—´ì¬ ëª©ë¡</button>
</div>

<div class="tab active" id="calculator">
  <h3>ğŸ“ ë²½ì²´ ë ˆì´ì–´ êµ¬ì„±</h3>
  <datalist id="insulationNames"></datalist>
  <table id="layerTable">
    <thead>
      <tr>
        <th>ì¬ë£Œëª…</th>
        <th>ë‘ê»˜ (mm)</th>
        <th>ì—´ì „ë„ìœ¨ Î»</th>
        <th>ì—´ì €í•­ R</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody>
      <tr class="fixed-layer">
        <td><input type="text" readonly value="ì‹¤ì™¸ ì—´ì „ë‹¬ì €í•­"></td>
        <td><input type="number" readonly value="0"></td>
        <td><input type="text" readonly value="-"></td>
        <td><input class="resistance" type="number" readonly value="0.043"></td>
        <td></td>
      </tr>
      <tr> <td>
          <input type="text" list="insulationNames" placeholder="ì¬ë£Œëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ"
                 onchange="fillFromInput(this)"
                 onfocus="handleMaterialFocus(this)"
                 onblur="handleMaterialBlur(this)">
          </td>
        <td><input type="number" oninput="updateResistance(this)"></td>
        <td><input type="number" oninput="updateResistance(this)"></td>
        <td><input class="resistance" type="number" readonly></td>
        <td><button onclick="removeRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr class="fixed-layer">
        <td><input type="text" readonly value="ì‹¤ë‚´ ì—´ì „ë‹¬ì €í•­"></td>
        <td><input type="number" readonly value="0"></td>
        <td><input type="text" readonly value="-"></td>
        <td><input class="resistance" type="number" readonly value="0.11"></td>
        <td></td>
      </tr>
    </tbody>
  </table>
  <button onclick="addRow()">ë ˆì´ì–´ ì¶”ê°€</button>
  <h4>ë‹¨ì—´ì¬ ë‘ê»˜ (mm): <input id="insulationThickness" type="number"/></h4>
  <h4>ì§€ì—­:
    <select id="region">
      <option value="ì¤‘ë¶€1">ì¤‘ë¶€1</option>
      <option value="ì¤‘ë¶€2">ì¤‘ë¶€2</option>
      <option value="ë‚¨ë¶€">ë‚¨ë¶€</option>
      <option value="ì œì£¼">ì œì£¼</option>
    </select>
    ë¶€ìœ„:
    <select id="zone">
      <option value="ì™¸ë²½">ì™¸ë²½</option>
      <option value="ì§€ë¶•">ì§€ë¶•</option>
      <option value="ë°”ë‹¥">ë°”ë‹¥</option>
    </select>
  </h4>
  <button onclick="calculate()">ì¶”ì²œ</button>
  <button onclick="window.print()">ğŸ“„ PDF ì €ì¥</button>
  <div id="result"></div>
</div>

<div class="tab" id="database">
  <h3>ğŸ“‹ ë‹¨ì—´ì¬ ëª©ë¡</h3>
  <table id="insulationTable">
    <thead><tr><th>ì´ë¦„</th><th>Î»</th><th>ë“±ê¸‰</th><th>ê°€ê²©</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>â• ë‹¨ì—´ì¬ ì¶”ê°€</h4>
  <input id="newName" placeholder="ì´ë¦„" type="text"/>
  <input id="newLambda" placeholder="Î» (W/mÂ·K)" type="number" step="0.001"/>
  <input id="newGrade" placeholder="ë“±ê¸‰" type="text"/>
  <input id="newPrice" placeholder="ê°€ê²©(ì›/ã¡)" type="number"/>
  <button onclick="addCustomInsulation()">ì¶”ê°€</button>
</div>

<script>
const uStandardTable = {
  'ì™¸ë²½': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.17, 'ë‚¨ë¶€': 0.22, 'ì œì£¼': 0.29 },
  'ì§€ë¶•': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.18, 'ë‚¨ë¶€': 0.25, 'ì œì£¼': 0.25 },
  'ë°”ë‹¥': { 'ì¤‘ë¶€1': 0.15, 'ì¤‘ë¶€2': 0.17, 'ë‚¨ë¶€': 0.22, 'ì œì£¼': 0.29 }
};

let insulationList = [
  {name: "PFë³´ë“œ A", lambda: 0.019, grade: "ë¶ˆì—°", price: 22000},
  {name: "ê²½ì§ˆìš°ë ˆíƒ„ B", lambda: 0.025, grade: "ì¤€ë¶ˆì—°", price: 18000},
  {name: "XPS C", lambda: 0.034, grade: "ë‚œì—°", price: 11000},
  {name: "ì§„ê³µë‹¨ì—´ D", lambda: 0.005, grade: "ë¶ˆì—°", price: 50000},
  {name: "EPS E", lambda: 0.038, grade: "ë‚œì—°", price: 8000}
];

// ì „ì—­ ë³€ìˆ˜ë¡œ í¬ì»¤ìŠ¤ëœ inputì˜ ì›ë˜ ê°’ì„ ì €ì¥
let materialInputOriginalValue = '';

function handleMaterialFocus(inputElement) {
    materialInputOriginalValue = inputElement.value;
    inputElement.value = ''; // ê°’ì„ ë¹„ì›Œì„œ datalistê°€ ëª¨ë“  ì˜µì…˜ì„ ë³´ì—¬ì£¼ë„ë¡ í•¨
}

function handleMaterialBlur(inputElement) {
    // setTimeoutì„ ì‚¬ìš©í•˜ì—¬ onchangeê°€ ë°œìƒí•˜ê³  input.valueê°€ ì—…ë°ì´íŠ¸ë  ì‹œê°„ì„ ì•½ê°„ ê¸°ë‹¤ë¦° í›„ íŒë‹¨.
    setTimeout(() => {
        if (inputElement.value === '' && materialInputOriginalValue !== '') {
            // ì‚¬ìš©ìê°€ í¬ì»¤ìŠ¤ í›„ ê°’ì„ ë¹„ìš°ê³ , ìƒˆ ê°’ì„ ì„ íƒí•˜ì§€ ì•Šê³  ë¸”ëŸ¬í•œ ê²½ìš°
            inputElement.value = materialInputOriginalValue; // ì›ë˜ ì¬ë£Œëª…ìœ¼ë¡œ ë³µì›
            fillFromInput(inputElement); // ë³µì›ëœ ì¬ë£Œëª…ì— ë”°ë¼ ëŒë‹¤ ë“± ì—…ë°ì´íŠ¸
        }
        // materialInputOriginalValue = ''; // ì—¬ê¸°ì„œ ì´ˆê¸°í™”í•˜ë©´ ë‹¤ë¥¸ input ê°„ì„­ ê°€ëŠ¥ì„± ìˆìŒ. focus ì‹œë§ˆë‹¤ ì„¤ì •.
    }, 0);
}

function fillFromInput(input) { // inputì€ ì¬ë£Œëª… input element
    const value = input.value;
    const row = input.closest("tr");
    const lambdaInput = row.cells[2].querySelector('input');
    const insulation = insulationList.find(ins => ins.name === value);

    if (insulation) {
        lambdaInput.value = insulation.lambda;
    } else {
        // ëª©ë¡ì— ì—†ëŠ” ì´ë¦„ì´ê±°ë‚˜, ì´ë¦„ì´ ì§€ì›Œì§„ ê²½ìš°
        if (value === '') { // ì‚¬ìš©ìê°€ ì´ë¦„ì„ ì™„ì „íˆ ì§€ì› ë‹¤ë©´
            lambdaInput.value = '';
        }
        // ì´ë¦„ì€ ìˆì§€ë§Œ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°, lambdaëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ë„ë¡ í˜„ì¬ ê°’ ìœ ì§€.
    }
    updateResistance(lambdaInput); // lambdaInput.valueì— ë”°ë¼ Rê°’ ì—…ë°ì´íŠ¸
}

function switchTab(id) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function updateResistance(input) {
  const row = input.closest("tr");
  // inputì´ ì†í•œ í–‰ì˜ ë‘ê»˜(cells[1])ì™€ ì—´ì „ë„ìœ¨(cells[2]) inputì„ ì°¾ìŒ
  const thicknessInput = row.cells[1].querySelector('input');
  const lambdaInput = row.cells[2].querySelector('input'); // ì´ inputì´ oninputì„ í˜¸ì¶œí•œ ì£¼ì²´ì¼ ìˆ˜ ìˆìŒ

  const t = parseFloat(thicknessInput.value) / 1000; // ë‘ê»˜ mm to m
  const l = parseFloat(lambdaInput.value);         // ì—´ì „ë„ìœ¨
  const R_input = row.cells[3].querySelector('input'); // ì—´ì €í•­ input

  if (!isNaN(t) && t >= 0 && !isNaN(l) && l > 0) {
    R_input.value = (t / l).toFixed(3);
  } else {
    R_input.value = ''; // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì—´ì €í•­ ê°’ ë¹„ì›€
  }
}


function addRow() {
  const tbody = document.querySelector("#layerTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>
      <input type="text" list="insulationNames" placeholder="ì¬ë£Œëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ"
             onchange="fillFromInput(this)"
             onfocus="handleMaterialFocus(this)"
             onblur="handleMaterialBlur(this)">
    </td>
    <td><input type="number" oninput="updateResistance(this)"></td>
    <td><input type="number" oninput="updateResistance(this)" step="0.001"></td>
    <td><input class="resistance" type="number" readonly></td>
    <td><button onclick="removeRow(this)">ì‚­ì œ</button></td>
  `;
  const rows = tbody.querySelectorAll("tr");
  tbody.insertBefore(row, rows[rows.length - 1]); // ë§ˆì§€ë§‰ ê³ ì •í–‰(ì‹¤ë‚´ ì—´ì „ë‹¬ì €í•­) ë°”ë¡œ ìœ„ì— ì‚½ì…
}

function removeRow(btn) {
  const row = btn.closest("tr");
  // ê³ ì •ëœ í–‰ì€ ì‚­ì œí•˜ì§€ ì•Šë„ë¡ ë°©ì§€ (ì„ íƒ ì‚¬í•­, í˜„ì¬ëŠ” classë¡œ êµ¬ë¶„ ê°€ëŠ¥)
  if (!row.classList.contains('fixed-layer')) {
      row.remove();
  }
}

function updateInsulationTable() {
  const tbody = document.querySelector("#insulationTable tbody");
  tbody.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
  const datalist = document.getElementById("insulationNames");
  if (!datalist) { // í˜¹ì‹œ datalistê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„ (ì •ìƒì ìœ¼ë¡  í•­ìƒ ìˆì–´ì•¼ í•¨)
      console.error("Datalist ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
  }
  datalist.innerHTML = ""; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”

  // insulationListë¥¼ lambda ê°’ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì„ íƒ ì‚¬í•­)
  // insulationList.sort((a, b) => a.lambda - b.lambda);

  for (const item of insulationList) {
    tbody.innerHTML += `<tr><td><span class="math-inline">\{item\.name\}</td\><td\></span>{item.lambda}</td><td><span class="math-inline">\{item\.grade \|\| '\-'\}</td\><td\></span>{item.price !== undefined ? item.price : '-'}</td></tr>`;
    datalist.innerHTML += `<option value="${item.name}">`;
  }
}

function addCustomInsulation() {
  const nameInput = document.getElementById("newName");
  const lambdaInput = document.getElementById("newLambda");
  const gradeInput = document.getElementById("newGrade");
  const priceInput = document.getElementById("newPrice");

  const name = nameInput.value.trim();
  const lambda = parseFloat(lambdaInput.value);
  const grade = gradeInput.value.trim();
  const price = parseFloat(priceInput.value);

  if (!name) {
    alert("ë‹¨ì—´ì¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
    nameInput.focus();
    return;
  }
  if (isNaN(lambda) || lambda <= 0) {
    alert("ìœ íš¨í•œ ì—´ì „ë„ìœ¨(Î») ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (0ë³´ë‹¤ í° ìˆ«ì).");
    lambdaInput.focus();
    return;
  }
  if (insulationList.some(item => item.name.toLowerCase() === name.toLowerCase())) {
    alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹¨ì—´ì¬ ì´ë¦„ì…ë‹ˆë‹¤.");
    nameInput.focus();
    return;
  }

  insulationList.push({name, lambda, grade: grade || undefined, price: isNaN(price) ? undefined : price});
  updateInsulationTable(); // ëª©ë¡ ë° datalist ì—…ë°ì´íŠ¸

  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  nameInput.value = '';
  lambdaInput.value = '';
  gradeInput.value = '';
  priceInput.value = '';
}

function calculate() {
  const region = document.getElementById('region').value;
  const zone = document.getElementById('zone').value;
  const insulationThicknessInput = document.getElementById('insulationThickness');
  const thickness = parseFloat(insulationThicknessInput.value) / 1000; // mm to m

  if (isNaN(thickness) || thickness <= 0) {
    alert("ë‹¨ì—´ì¬ ë‘ê»˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (0ë³´ë‹¤ í° ê°’).");
    insulationThicknessInput.focus();
    return;
  }

  let R_wall_parts = 0; // ì‚¬ìš©ìê°€ êµ¬ì„±í•œ ë ˆì´ì–´ë“¤ì˜ ì—´ì €í•­ í•© (ê³ ì • ì €í•­ ì œì™¸)
  let userLayersValid = false; // ì‚¬ìš©ìê°€ ìœ íš¨í•œ ë ˆì´ì–´ë¥¼ í•˜ë‚˜ë¼ë„ êµ¬ì„±í–ˆëŠ”ì§€ í™•ì¸

  const layerRows = Array.from(document.querySelectorAll("#layerTable tbody tr"));

  for (const row of layerRows) {
    if (row.classList.contains('fixed-layer')) {
        const fixedResistanceInput = row.cells[3].querySelector('input.resistance');
        if (fixedResistanceInput) {
            const val = parseFloat(fixedResistanceInput.value);
            if (!isNaN(val)) {
                R_wall_parts += val;
            }
        }
    } else {
        // ë™ì  ë ˆì´ì–´ (ì‚¬ìš©ì ì¶”ê°€ ë ˆì´ì–´)
        const materialNameInput = row.cells[0].querySelector('input');
        const thicknessVal = parseFloat(row.cells[1].querySelector('input').value);
        const lambdaVal = parseFloat(row.cells[2].querySelector('input').value);
        const resistanceVal = parseFloat(row.cells[3].querySelector('input.resistance').value);

        // ì¬ë£Œëª…, ë‘ê»˜, ëŒë‹¤ê°€ ëª¨ë‘ ìœ íš¨í•˜ê²Œ ì…ë ¥ë˜ì–´ ì—´ì €í•­ì´ ê³„ì‚°ëœ ê²½ìš°ì—ë§Œ í•©ì‚°
        if (materialNameInput && materialNameInput.value.trim() !== "" &&
            !isNaN(thicknessVal) && thicknessVal > 0 &&
            !isNaN(lambdaVal) && lambdaVal > 0 &&
            !isNaN(resistanceVal) && resistanceVal > 0) {
            R_wall_parts += resistanceVal;
            userLayersValid = true; // ìœ íš¨í•œ ì‚¬ìš©ì ë ˆì´ì–´ê°€ í•˜ë‚˜ ì´ìƒ ì¡´ì¬
        } else if (materialNameInput && materialNameInput.value.trim() !== "") {
            // ì¬ë£Œëª…ì€ ìˆìœ¼ë‚˜ ë‹¤ë¥¸ ê°’ì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
            alert(`ë ˆì´ì–´ "${materialNameInput.value}"ì˜ ë‘ê»˜ ë˜ëŠ” ì—´ì „ë„ìœ¨ ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•´ë‹¹ ë ˆì´ì–´ëŠ” ê³„ì‚°ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.`);
        }
    }
  }

  if (!userLayersValid && layerRows.filter(r => !r.classList.contains('fixed-layer')).length > 0) {
      alert("í•˜ë‚˜ ì´ìƒì˜ ë²½ì²´ ë ˆì´ì–´ì— ìœ íš¨í•œ ì¬ë£Œ, ë‘ê»˜, ì—´ì „ë„ìœ¨ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
  }


  const U_target = uStandardTable[zone][region];
  const R_required_total = 1 / U_target;

  // R_additional_needed_from_insulation ì€ ì‚¬ì‹¤ìƒ (R_required_total - R_wall_parts)
  // ë§Œì•½ ì´ ê°’ì´ 0 ì´í•˜ë©´ ì´ë¯¸ ë§Œì¡±.
  // ì´ ê°’ì€ ì§€ì •ëœ ë‘ê»˜(thickness)ì˜ "ì–´ë–¤ ë‹¨ì—´ì¬"ê°€ ì œê³µí•´ì•¼ í•˜ëŠ” ì—´ì €í•­.
  const R_insulation_must_provide = R_required_total - R_wall_parts;


  const resultDiv = document.getElementById("result");
  const current_U_wall = R_wall_parts > 0 ? (1 / R_wall_parts).toFixed(3) : "âˆ";

  if (R_insulation_must_provide <= 0) {
      resultDiv.innerHTML = `<p>ğŸ“Œ ê¸°ì¤€ ì—´ê´€ë¥˜ìœ¨ (U_target): <b>${U_target.toFixed(3)} W/ã¡Â·K</b> (ëª©í‘œ ì´ ì—´ì €í•­ R_total_req: <span class="math-inline">\{R\_required\_total\.toFixed\(3\)\} mÂ²Â·K/W\)</p\>
<p\>ğŸ§± í˜„ì¬ êµ¬ì„±ëœ ëª¨ë“  ë ˆì´ì–´ì˜ ì´ ì—´ì €í•­ \(R\_current\_total\)\: <b\></span>{R_wall_parts.toFixed(3)} mÂ²Â·K/W</b> (í˜„ì¬ ì´ ì—´ê´€ë¥˜ìœ¨ U_current_total: ${current_U_wall} W/ã¡Â·K)</p>
        <p style="color: green;">âœ… í˜„ì¬ êµ¬ì„±ìœ¼ë¡œ ì´ë¯¸ ë²•ì  ê¸°ì¤€ ì—´
